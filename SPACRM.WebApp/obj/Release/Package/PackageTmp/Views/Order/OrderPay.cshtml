@{
    ViewBag.Title = "订单支付";
    var orgId = ViewData["ORG_ID"] == null ? "0" : ViewData["ORG_ID"].ToString();
}
@model SPACRM.Entity.Entities.ORDER_HEAD_EX
@using SPACRM.Entity.Entities
<h2>订单支付</h2>
<style>
    table {
        width: 100%;
    }

        table tbody {
        }

    .divHead {
        height: 30px;
        background-color: #FCF3D0;
        border: 1px solid #F7DC6F;
        color: #927608;
    }

    #tCustInfo {
        border: 0px solid #e6e5e5;
        margin-top: 0px;
        line-height: 30px;
    }

    #divPaymentMode ul {
        list-style: none;
    }

        #divPaymentMode ul li {
            float: left;
            width: 500px;
        }

            #divPaymentMode ul li label {
                width: 100px;
                text-align: right;
            }

    #spanPresent {
        cursor: pointer;
    }

    #divLCPaymentMode .ul {
        list-style: none;
    }

        #divLCPaymentMode .ul li {
            float: left;
            width: 280px;
        }

    #divLCPaymentMode ul li label {
        width: 100px;
        text-align: right;
    }
</style>

<style type="text/css">
    .progress {
        z-index: 2000;
    }

    .mask {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
    }

    #EMP_NAME {
        height: 25px;
    }

    .artw_mask {
        background-color: #000;
        position: fixed;
        overflow: auto;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        filter: alpha(opacity=50);
        display: none;
        z-index: 2;
    }

    .artw_boxcontain {
        margin: 0 auto;
        position: fixed;
        overflow: auto;
        z-index: 999;
        line-height: 28px;
        display: none;
    }

    .artw_showbox {
        padding: 10px;
        background: #FFF;
        border-radius: 5px;
        margin: 20px;
        min-width: 300px;
        min-height: 200px;
    }

    .artw_title {
        position: relative;
        height: 27px;
        border-bottom: 1px solid #999;
    }

    .artw_close {
        position: absolute;
        cursor: pointer;
        outline: none;
        top: 0;
        right: 0;
        z-index: 4;
        width: 42px;
        height: 42px;
        overflow: hidden;
        background-image: url(../../assets/js/Index_files/feedback-close.png);
        _background: none;
    }

    .artw_message {
        padding: 10px 0px;
        overflow: hidden;
        line-height: 19px;
    }







    a.closeBtn {
        position: absolute;
        top: 0px;
        right: 0px;
        width: 30px;
        display: block;
        border-left: 1px solid #85B6E2;
        border-bottom: 1px solid #85B6E2;
        padding: 4px 0;
        text-align: center;
        color: #333;
    }

        a.closeBtn:hover {
            color: #fff;
            border: 1px solid #85B6E2;
            background: #85B6E2;
        }

    .windo {
        position: absolute;
        /*top:555px;
left:200px;*/
        font-size: 9pt;
        display: block;
        min-height: 250px;
        max-height: 400px;
        width: 400px;
        background-color: transparent;
        display: none;
        height: 290px;
        -webkit-border-radius: 3px;
        -moz-border-radius: 3px;
        border-radius: 3px 0px 3px 3px;
        -webkit-box-shadow: 0 0 3px #555;
        -moz-box-shadow: 0 0 3px #555;
        box-shadow: 0 0 3px #555;
    }

    s {
        position: absolute;
        top: -20px;
        left: 190px;
        display: block;
        height: 0;
        width: 0;
        font-size: 0;
        line-height: 0;
        border-color: transparent transparent #85B6E2 transparent;
        border-style: dashed dashed solid dashed;
        border-width: 10px;
    }

    .lil {
        position: absolute;
        top: -9px;
        *top: -9px;
        left: -10px;
        display: block;
        height: 0;
        width: 0;
        font-size: 0;
        line-height: 0;
        border-color: transparent transparent #FFFFFF transparent;
        border-style: dashed dashed solid dashed;
        border-width: 10px;
    }

    .windo .content {
        border: 1px solid #85B6E2;
        -moz-border-radius: 3px;
        -webkit-border-radius: 3px;
        position: absolute;
        background-color: #FFF;
        width: 100%;
        height: 100%;
        padding: 5px;
        *top: -2px;
        *border-top: 1px solid #fff;
        *border-top: 1px solid #fff;
        *border-left: none;
        *border-right: none;
        *height: 102px;
    }

    .td-right {
        text-align: left;
        width: 7%;
        padding: 2px 5px 2px 5px;
    }

    .td-left {
        text-align: left;
        width: 13%;
        padding: 2px 5px 2px 5px;
    }

    .Query-td-right {
        text-align: left;
        width: 7%;
        padding: 2px 5px 2px 5px;
    }

    .Query-td-left {
        text-align: left;
        width: 23%;
        padding: 2px 5px 2px 5px;
    }




    #searchresult {
        width: 130px;
        position: absolute;
        z-index: 1;
        overflow: hidden;
        left: 130px;
        top: 71px;
        background: #ffffff;
        border-top: none;
    }

    .line {
        font-size: 12px;
        background: #ffffff;
        width: 130px;
        padding: 2px;
    }

    .hover {
        background: #007ab8;
        width: 130px;
        color: #fff;
    }

    .std {
        width: 150px;
    }
</style>
<form action="@Url.Action("PaymentSave2")" id="formPaySave" method="post" role="form">
    <input type="hidden" id="orgname" value="@ViewBag.orgname" />
    <input type="hidden" name="CUST_CARD_ID" id="CUST_CARD_ID" value="0" /><!--会员卡ID储值账户-->
    <input type="hidden" name="CUST_CARD_ID2" id="CUST_CARD_ID2" value="0" /><!--会员卡ID赠送账户-->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h4>订单详情</h4>
                    <div class="options">
                        <a href="#" id="btnOrderSK" style="opacity: 1; display: none;">[会员卡刷卡]</a>
                        <a href="#" id="btnOrderPrint" style="opacity: 1;">[打印订单]</a>
                        @if (Model.CUST_NAME != "散客")
                        {
                            <a href="@Url.Action("filesshow", "Customer", new { cid = Model.CUST_ID })" target="_blank" style="opacity: 1;">[查看附件]</a>
                        }
                    </div>
                </div>
                <div class="panel-body">
                    <div style="color: #927608;">
                        <div class="col-md-3">
                            <b>订单号：<span> @Model.ORDER_NO</span></b>
                        </div>
                        <div class="col-md-3">
                            <b>顾客姓名：<span> @Model.CUST_NAME</span></b>
                        </div>
                        <div class="col-md-3">
                            <b>应付总额：￥<span style="color: red;"> @Model.PAY_AMT</span></b>
                            <input type="hidden" id="pay_amt" value="@Model.PAY_AMT" />
                        </div>

                        <div class="col-md-3">
                            <b>
                                @* @if (!string.IsNullOrEmpty(ViewBag.OpName))
                            {
                                @ViewBag.OpName *@<span>优惠：￥</span><span style="color: red;" id="spanYH">@(Model.TOTAL_AMT - Model.PAY_AMT)</span>
                                @*}*@
                            </b>
                        </div>
                        @if (ViewBag.Proc_Amt > 0)
                        {
                            <div class="col-md-3">
                                <b>本次疗程支付：￥</b><span style="color: red;"> @ViewBag.Proc_Amt</span>
                            </div>
                        }
                        <div class="col-md-3">
                            <b>还需支付：￥<span id="spanResAmount" style="color: red;">@ViewBag.BlanceAmt</span>
                            </b>
                        </div>
                        <b>
                            <div id="divhykye">
                                @foreach (CustPayMode_EX card in ViewBag.CustPay)
                                {
                                    <div class='col-md-3'><b>余额(@card.NAME)：￥<span id='spanczzh_@card.ID' style='color: red;'>@card.BALANCE</span></b></div>
                                }
                            </div>
                        </b>
                    </div>
                    <br />
                    <div class="col-md-12" style="padding-left: 0px;">
                        <br />
                        <span style="color: #927608; font-weight: bolder;">明细：</span>
                    </div>
                    <div style="height: 1px; background-color: #ede8e8; width: 100%; margin-top: 60px;"></div>
                    <div style="margin-top: 5px;">
                        <table style="width: 100%">
                            <thead>
                                <tr>
                                    <th>项目
                                    </th>
                                    <th>员工
                                    </th>
                                    <th>是否点钟
                                    </th>
                                    <th>原价
                                    </th>
                                    <th>优惠
                                    </th>
                                    <th>金额
                                    </th>

                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in (List<ORDER_DETAIL_EX>)ViewBag.proItemList)
                                { 
                                    <tr>
                                        <td>@item.PROD_NAME</td>
                                        <td>@item.EMPLOYEE_NAME</td>
                                        <td>@(item.IS_DK == true ? "是" : "否")</td>
                                        <td>￥@item.PROD_PRICE</td>
                                        @*  <td><select style="width:120px;" id="selectPrivilege_' + @item.ID + '_' + @item.CUST_ID + '_' + 0 + '_' + @item.ID + '" name="selectPrivilege" onchange="privilege(this)"><option value='0'>请选择优惠/活动</option><option value='-1'>直接改价</option></select>
                                              <input type="hidden" name="proPrivilege" />
                                          </td>*@
                                        <td>@item.PROMOTIONNAME</td>
                                        <td>￥@item.PROD_AMT</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <br />
                    <span style="color: #927608; font-weight: bolder;">支付：@if (((List<CustPayMode_EX>)ViewBag.CustPay).Count > 0)
                                                                          {<input type="checkbox" id="isft" name="isft" style="margin-left: 60px;" /><span>允许从实际卡付反推抵扣金额</span>}</span>
                    <div style="height: 1px; background-color: #ede8e8; width: 100%;"></div>
                    @* <div class="form-group">
                        <div style="width: 200px;">
                            <br />
                            选择会员卡：  @Html.ResourceDropDownList("VIPCARD_TYPE", "VIPCARD_TYPE", "类型", new { @class = "form-control" }, Request.QueryString["cid"], false)
                        </div>
                    </div>*@

                    @* @if (ViewBag.XMAMT != 0)
                    {
                        *@<div class="form-group col-xs-6 panel panel-primary">
                            <b>项目支付方式</b>
                            <div style="margin-left: 100px;">还需支付￥：<span id="xmspanPayed" class="badge badge-info">@ViewBag.XMAMT</span></div>
                            <input type="hidden" id="xmamt" value="@ViewBag.XMAMT" />
                            <div id="divPaymentMode" style="padding: 5px; width: 100%;">
                                <ul style="float: left;" id="xmpay">
                                    @if (((CUST_INFO_EX)(ViewBag.CustInfo)).IS_UNREGISTER ==false) {
                                    foreach (CustPayMode_EX card in ViewBag.CustPay)
                                    {
                                        <label style="width: 100%; color: red;" id="lbhyk1">会员卡:(@card.NAME,余:￥@card.BALANCE)</label>
                                        <li class="mode" id="xmhyk1" name="xmhyk1">
                                            <label style="color: blue;">项目抵扣金额：</label>
                                            <input type="hidden" name="xmPaymentModeType" value="5" />
                                            <input type="hidden" name="xmPaymentModeCode" value="9" />
                                            <input type="hidden" name="xmye" value="@card.BALANCE" />
                                            <input type="hidden" name="xmid" value="@card.ID" />
                                            <input type="hidden" name="xmzk" value="@card.DISCOUNT_RATE" />
                                            <input name="xmPaymentMode" id="xmdk_@card.ID" @(ViewBag.XMAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "") maxlength="6" type="text" onkeydown="xmjets(this);" onkeyup="xmjets(this);" />
                                        </li>
                                        <li class="mode" id="xmhyk2">
                                            <label style="color: blue;">实际卡付：</label>
                                            <input type="hidden" name="xmPaymentModeType2" value="5" />
                                            <input type="hidden" name="xmPaymentModeCode2" value="9" />
                                            <input name="xmPaymentMode2" id="xmsj_@card.ID" @(ViewBag.XMAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "") maxlength="6" type="text" onkeydown="xmjeft(this);" onkeyup="xmjeft(this);" />
                                        </li>
                                    }}
                                    else{
                                        <label style="width: 100%; color: red;" >会员卡未记名</label>
                                    }
                                   
                                    @foreach (CustPayMode_EX card in ViewBag.CustPayV)
                                    {  <hr style="width: 100%;" />
                                        <label style="width: 100%; color: red;" id="lbhyk1">电子券:(@card.NAME,余:￥@card.BALANCE)</label>
                                        <li class="mode" id="xmhyk3" name="xmhyk3">
                                            <label>券号：</label>
                                            <input type="hidden" name="xmPaymentModeType" value="6" />
                                            <input type="hidden" name="xmPaymentModeCode" value="6" />
                                            <input type="text" maxlength="100"  placeholder="请输入券号" value="@if (((CUST_INFO_EX)(ViewBag.CustInfo)).TYPE != 0) {  @card.VOUCHER_NO  }" id="txtVNO_@card.ID" name="VOUCHAR_NO" @(ViewBag.XMAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "") />

                                            <button type="button" id="btnCheckPROM_@card.ID" onclick="CheckV(this);" style="padding: 4px 15px 4px 15px;" class="btn btn-primary">使用</button>
                                            <span ></span>
                                            <input id="qh_@card.ID" name="xmqh" value="@card.VOUCHER_NO" type="hidden" />
                                            <input id="V_@card.ID" name="xmPaymentMode" value="0" type="hidden" />
                                            <input id="VNO_@card.ID" type="hidden" name="xmVNO" />
                                            <input id="VID_@card.ID" type="hidden" name="xmVID" />
                                            <input id="value_@card.ID" type="hidden" name="xmye" value="@card.BALANCE" />
                                            <input id="id_@card.ID" type="hidden" name="qhid" value="@card.ID" />
                                        </li>
                                    }
                                    @if (ViewBag.paymentList2 != null)
                                    {
                                        string type = "";
                                        foreach (var item in ViewBag.paymentList2)
                                        {
                                            if (type != item.TYPE)
                                            {
                                        <hr style="width: 100%;" />
                                                type = item.TYPE;
                                        <label style="width: 100%; color: red;">@item.PAYMODE:</label>
                                            }
                                        <li class="mode">
                                            <label>@item.NAME：</label>
                                            <input type="hidden" name="xmPaymentModeType" value="@item.TYPE" />
                                            <input type="hidden" name="xmPaymentModeCode" value="@item.ID" />
                                            <input title="@item.PAYMODE" name="xmPaymentMode" @(ViewBag.XMAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "") maxlength="6" type="text" onkeydown="xmpaymoney(this);" onkeyup="xmpaymoney(this);" />
                                            @if (@item.ID == 19)
                                            {
                                                <select name="xmqd" style="width:155px;"  @(ViewBag.XMAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "")>
                                                    @foreach (SPACRM.Entity.ORG_DICT d in ViewBag.QD)
                                                    {
                                                        <option  value="@d.DICT_CODE">@d.DICT_VALUE </option>
                                                    }


                                                </select>   
                                            }
                                        </li>
                                        }
                                    }
                                    <li class="mode">
                                        <label>代金券：</label>
                                        <input type="hidden" name="xmPaymentModeType" value="3" />
                                        <input type="hidden" name="xmPaymentModeCode" value="6" />
                                        <input type="text" maxlength="100" style="width:300px;" placeholder="多个券号用英文半角逗号隔开" id="txtVOUCHAR_NO" name="VOUCHAR_NO" @(ViewBag.XMAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "") />

                                        <button type="button" id="btnCheckPROM" style="padding: 4px 15px 4px 15px;" class="btn btn-primary">使用</button>
                                        <span id="Pro_Voucher"></span>
                                        <input id="Pro_FaceValue" name="xmPaymentMode" value="0" type="hidden" />
                                        <input id="Pro_No" type="hidden" name="xmVoucherNO" />
                                        <input id="Pro_Id" type="hidden" name="xmVoucherID" />
                                    </li>
                                </ul>
                            </div>
                        </div>
                    @* }*@
                    @* @if (ViewBag.CPAMT != 0)
                    {
                        *@<div class="form-group col-xs-6 panel panel-primary">
                            <b>产品支付方式</b>
                            <div style="margin-left: 100px;">还需支付￥：<span id="cpspanPayed" class="badge badge-info">@ViewBag.CPAMT</span></div>
                            <input type="hidden" id="cpamt" value="@ViewBag.CPAMT" />
                            <div id="divPaymentMode" style="padding: 5px; width: 100%;">
                                <ul style="float: left;" id="cppay">
                                    @foreach (CustPayMode_EX card in ViewBag.CustPay)
                                    {
                                        <label style="width: 100%; color: red;" id="lbhyk2">会员卡:(@card.NAME,余:￥@card.BALANCE)</label>
                                        <li class="mode" id="cphyk1" name="cphyk1">
                                            <label style="color: blue;">产品抵扣金额：</label>
                                            <input type="hidden" name="cpPaymentModeType" value="5" />
                                            <input type="hidden" name="cpPaymentModeCode" value="9" />
                                            <input type="hidden" name="cpye" value="@card.BALANCE" />
                                            <input type="hidden" name="cpid" value="@card.ID" />
                                            <input type="hidden" name="cpzk" value="@card.DISCOUNT_RATE2" />
                                            <input name="cpPaymentMode" id="cpdk_@card.ID" @(ViewBag.CPAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "") maxlength="6" type="text" onkeydown="cpjets(this);" onkeyup="cpjets(this);" />
                                        </li>
                                        <li class="mode" id="cphyk2">
                                            <label style="color: blue;">实际卡付：</label>
                                            <input type="hidden" name="cpPaymentModeType2" value="5" />
                                            <input type="hidden" name="cpPaymentModeCode2" value="9" />
                                            <input name="cpPaymentMode2" id="cpsj_@card.ID" @(ViewBag.CPAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "") maxlength="6" type="text" onkeydown="cpjeft(this);" onkeyup="cpjeft(this);" />
                                        </li>
                                    }
                                    @if (ViewBag.paymentList0 != null)
                                    {
                                        string type = "";
                                        foreach (var item in ViewBag.paymentList0)
                                        {
                                            if (type != item.TYPE)
                                            {
                                        <hr style="width: 100%;" />
                                                type = item.TYPE;
                                        <label style="width: 100%; color: red;">@item.PAYMODE:</label>
                                            }
                                        <li class="mode">
                                            <label>@item.NAME：</label>
                                            <input type="hidden" name="cpPaymentModeType" value="@item.TYPE" />
                                            <input type="hidden" name="cpPaymentModeCode" value="@item.ID" />

                                            <input title="@item.PAYMODE"  name="cpPaymentMode" maxlength="6" type="text" onkeydown="cppaymoney(this);" onkeyup="cppaymoney(this);" @(ViewBag.CPAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "") />
                                            @if (@item.ID == 19)
                                            {
                                                <select name="cpqd" style="width:155px;"  @(ViewBag.CPAMT == 0 ? "readonly style=background-color:#FAFAFA;cursor:not-allowed;" : "")>
                                                    @foreach (SPACRM.Entity.ORG_DICT d in ViewBag.QD)
                                                    {
                                                        <option value="@d.DICT_CODE">@d.DICT_VALUE </option>
                                                    }
                                                </select>   
                                            }
                                        </li>
                                        }
                                    }
                                </ul>
                            </div>
                        </div>
                    @*  }*@


                    <div class="form-group btnpanel_right" id="divBtnSave" style="margin-top: 5px;">
                        @if (((List<CustPayMode_EX>)ViewBag.CustPay).Count > 0)
                        {
                            if (((List<CustPayMode_EX>)ViewBag.CustPay)[((List<CustPayMode_EX>)ViewBag.CustPay).Count - 1].END_DATE >=DateTime.Parse(DateTime.Now.ToString("yyyy-MM-dd")))
                            {
                            <button type="button" id="btnSave2" class="btn btn-primary">结账</button>
                            }
                            else
                            {
                            <script type="text/javascript">
                                alert("会员卡已过期，不可结账。");
                            </script>
                            }
                        }
                        else
                        {
                            <button type="button" id="btnSave2" class="btn btn-primary">结账</button>
                        }
                        <button type="button" id="btnReturn" class="btn btn-default">返回</button>
                    </div>
                </div>
            </div>
        </div> 
    </div>
    <input type="hidden" id="hide_ProCARD_RATE" /><!--产品储值账户扣率-->
    <input type="hidden" id="hide_SerCARD_RATE" /><!--项目储值账户折扣-->
    <input type="hidden" id="hide_ProCARD_RATE2" /><!--产品赠送账户扣率-->

    <input type="hidden" id="hide_SerCARD_RATE2" /><!--项目赠送账户折扣-->
    <input type="hidden" id="hide_Arrears" /><!--欠款-->
    <input type="hidden" id="hide_oid" name="oid" value="@Request.QueryString["oid"]" />
    <input type="hidden" id="hide_cid" name="cid" value="@Request.QueryString["cid"]" />
    <input type="hidden" id="hide_Point_Mode" value="@ViewBag.PointMode" />
    <input type="hidden" id="hide_chuzhizhanghu" value="0" /><!--储值账户-->
    <input type="hidden" id="hide_zengsongzhanghu" value="0" /><!--赠送账户-->

</form>

<form id="SearchProdInfo2" method="post" role="form">
    <div id="QueryProdInfo_mask2" class="artw_mask"></div>
    <div id="QueryProdInfo_boxcontain2" class="artw_boxcontain" style="width: 490px; height: 400px;">
        <a id="QueryProdInfo_close2" href="javascript:void(0);" title="Close" class="artw_close"></a>
        <div id="QueryProdInfo_showbox2" class="artw_showbox">
            <div id="QueryProdInfo_title2" class="artw_title">
                <h5>会员卡</h5>
            </div>
            <div id="QueryProdInfo_message2" class="artw_message" style="width: 430px; height: 300px;">

                <div>
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <td>选择会员卡:</td>
                                <td>
                                @Html.ResourceDropDownList("VIPCARD_TYPE", "VIPCARD_TYPE", "类型", new { @class = "form-control" }, Request.QueryString["cid"], false)
                            </tr>
                            <tr>
                                <td></td>
                                <td>
                                    <button type="button" id="btnduka" class="btn btn-primary">
                                        确 定</button>
                                    @*<button type="button" id="btnCancel" class="btn btn-default">不使用会员卡</button>*@
                                </td>
                            </tr>
                        </thead>
                        <tbody style="font-size: 12px;" id="Cust_Card_List">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</form>
@section jssection{
    <script type="text/javascript">
        var util = {};
        var options = {
            queryCardDetail: "@Url.Action("CustCardDetail", "Common")",
            checkVOCHER_NO: "@Url.Action("CheckVocherNo")",
            printUrl: "@Html.Raw(Url.Action("ConsumeOrderPrint", new { cid = Request.QueryString["cid"], oid = Request.QueryString["oid"] }))",
            printEnUrl: "@Html.Raw(Url.Action("OrderPrint", new { cid = Request.QueryString["cid"], oid = Request.QueryString["oid"] }))"
        };
    </script>

    @Html.Js("plugins/validator/validator", "app/order/orderpay")
}

