<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="Keywords" content="" />
    <meta name="Description" content="" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <title>平安献礼30年</title>
    <style>
        .yhq-pic img { display: none; }
    </style>
</head>
<body>
    <div class="wrap userflow-page userflow2-page">
        <div class="yhq-txt">
            <img src="../images/yhq-txt.png" alt="">
        </div>
        <div class="yhq-pic">
            <img src="../images/10.png" alt="99减10" class="show_pic1">
            <img src="../images/50.png" alt="499减50" class="show_pic2">
            <img src="../images/100.png" alt="999减100" class="show_pic3">
        </div>
        <form action="" class="form-tel">
            <p>速速填写手机号，领取优惠 !</p>
            <div class="name-input"><label for="">手机</label><input type="tel" maxlength="11" name="phone" value="" id="phone"></div>
            <div class="ljlq-btn">
                <img src="../images/ljlq.png" alt="">
            </div>
            <div class="pdName"></div>
            <!--领取成功弹层 -->
            <div class="mask mask-prize mask-yhq">
                <h3><img src="../images/lqcg.png" alt=""></h3>
                <div class="prize-btn download-btn"> <img src="../images/jgj.png" alt=""></div>
                <a class="prize-btn again-btn" href="./building.aspx"> <img src="../images/again.png" alt=""></a>
                <div class="prize-btn invite-btn"> <a href="./share.html"><img src="../images/other.png" alt=""></a></div>
            </div>
            <div class="mask mask-prize mask-ewm">
                <div class="ewm"><img src="../images/QRcode.jpg" alt=""></div>
                <p><img src="../images/ewm-txt.png" alt=""></p>
            </div>
    </div>
    <script src="../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="../js/wxshare.js"></script>
    <script src="../js/pv.record.js"></script>
    <script>
        //该页面不能通过url直接访问
        //if (document.referrer == "") {
        //    location.href = "load.aspx"
        //}

        $(".ljlq-btn").click(function () {
            var referrer = document.referrer;
            getCoupon();
            //如果来源于中奖页面，则需要新增抽奖资格
            //if (referrer.indexOf("building-share") > 0) {
            //    getCoupon();
            //}
            //else if (referrer.indexOf("myprize") > 0) //来源于我的奖品页面，则用户是领取优惠券（不需要新增抽奖资格）
            //{
            //    getCouponFromJawha();
            //}
        })

        //toast
        var toast = function () {
            $('.pdName').css({
                'display': 'block'
            })
            timer = setTimeout(function () {
                $('.pdName').css({
                    'display': 'none'
                })
            }, 2000)
            return false;
        };

        //验证手机号
        function verify() {
            var phone = $("#phone"),
                regPhone = /^1[3|4|5|6|7|8][0-9]{9}$/,
                html_2 = "请输入您的手机号!";
            html_3 = "您的手机号输入有误!";
            if (phone.val().trim() == "") {
                $('.pdName').html(html_2);
                toast();
                return false;
            } else if (!regPhone.test(phone.val().trim())) {
                $('.pdName').html(html_3);
                toast();
                phone.val("");
                return false;
            } else {
                return true;
            }
        }

        //本地领取优惠券（其实只是新增了中奖记录）
        function getCoupon() {
            if (verify()) {
                var requestData = "mobile=" + $("#phone").val()
                    + "&lottery_record_id=" + $.getQueryString("id")
                    + "&prize_code=" + $.getQueryString("prizecode")
                    + "&prize_name=" + $.getQueryString("prizename");

                $.ajax({
                    type: "post",
                    url: $.domainUrl + "AddGetRecordCoupon",
                    data: requestData,
                    success: function (result) {
                        var data = $.parseJSON(result);
                        if (data.Status == 1) {
                            $(".mask-yhq").fadeIn();
                            getCouponFromJawha();
                        } else if (data.Status == 2) {
                            // alert(data.Message);
                            $('.pdName').html(data.Message);
                            toast();
                        } else if (data.Status == -2) {
                            window.location.href = "load.aspx";
                        } else if (res.Status == -5) {
                            window.location.href = "index.aspx";
                        }
                    }
                });
            }
        }
        //从家化远程获取优惠券（真正获得优惠券）
        function getCouponFromJawha() {
            var batchid = "";
            var prizecode = $.getQueryString("prizecode");
            switch (prizecode) {
                case "P0004": batchid = "ACAAAC04809491"; break;
                case "P0005": batchid = "ACAAAC04809490"; break;
                case "P0006": batchid = "ACAAAC04809489"; break;
            }

            var requestData = "mobile=" + $("#phone").val()
                + "&batchid=" + batchid+""
            $.ajax({
                type: "post",
                url: $.domainUrl + "GetCoupon",
                data: requestData,
                success: function (result) {
                    var data = $.parseJSON(result);
                    //if (data.Status == 1) {
                        var lottery_record_id = $.getQueryString("id");
                        //领取成功修改优惠券状态
                        $.ajax({
                            type: "post",
                            url: $.domainUrl + "UpdatePrizeIsGetStatus",
                            data: { id: lottery_record_id },
                            success: function (result) {
                                var data = $.parseJSON(result);
                                if (data.Status == 1) {
                                    //领取成功
                                    $(".mask-yhq").fadeIn();
                                } else if (res.Status == -5) {
                                    window.location.href = "index.aspx";
                                }
                            }
                        });
                    //}
                }
            });
        }

        //下载二维码
        $(function () {
            var ewm = $(".download-btn");
            ewm.click(function () {
                $(".mask-ewm").fadeIn();
            })
        });

        //根据参数显示相应的卡券
        var prizecode = $.getQueryString("prizecode");
        switch (prizecode) {
            case "P0004": $(".show_pic3").show(); break;
            case "P0005": $(".show_pic2").show(); break;
            case "P0006": $(".show_pic1").show(); break;
        }
    </script>
</body>
</html>