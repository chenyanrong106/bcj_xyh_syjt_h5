<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="Keywords" content="" />
    <meta name="Description" content="" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <title>平安献礼30年</title>
    <style>
        .prize-content:before { content: ''; display: table; }
        .prize-content img, .prize-xs { display: none; }
    </style>
</head>
<body>
    <div class="wrap userflow-page">
        <!-- 金银条begin -->
        <div class="prize-content">
            <img src="../images/prize-silver.png" alt="银奖" class="show_pic1">
            <img src="../images/prize-gold.png" alt="金奖" class="show_pic2">
        </div>
        <!-- 金银条end -->
        <!-- 香水begin -->
        <div class="prize-xs">
            <img src="../images/prize-xs.jpg" alt="香水" class="show_pic3">
        </div>
        <!-- 香水end-->
        <!-- form -->
        <form action="" class="form-info">
            <p>速速填写地址，礼物很快就到！</p>
            <div class="form">
                <ul>
                    <li><label for="">姓名</label><input type="text" maxlength="50" name="username" value="" id="username"></li>
                    <li><label for="">手机</label><input type="tel" maxlength="11" name="phone" value="" id="phone"></li>
                    <li><label for="">地址</label><input type="text" maxlength="300" name="address" value="" id="address"></li>
                    <li>请认真填写地址（省／市／区／路／号）</li>
                </ul>
            </div>
            <div class="commit-btn">
                <img src="../images/commit.png" alt="">
            </div>
        </form>
        <!--提示框  -->
        <div class="pdName"></div>
    </div>
    <!--提交成功弹层 -->
    <div class="mask mask-prize">
        <div class="commit-txt"><img src="../images/sub-txt.png" alt=""></div>
        <a class="prize-btn again-btn" href="./building.aspx"> <img src="../images/again.png" alt=""></a>
        <div class="prize-btn invite-btn"><a href="./share.html"><img src="../images/other.png" alt=""></a></div>
    </div>
    <script src="../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="../js/wxshare.js"></script>
    <script src="../js/pv.record.js"></script>
    <script>
        //该页面不能通过url直接访问
        //if (document.referrer == "") {
        //    location.href = "load.aspx"
        //}

        $(".commit-btn").click(function () {
            getPrize();
        })

        //toast
        var toast = function () {
            $('.pdName').css({
                'display': 'block'
            })
            timer = setTimeout(function () {
                $('.pdName').css({
                    'display': 'none'
                })
            }, 2000);
            return false;
        };
        //表单验证
        function verify() {
            var name = $("#username"),
                phone = $("#phone"),
                address = $("#address"),
                regPhone = /^1[3|4|5|7|8][0-9]{9}$/,
                html_1 = "请输入您的姓名!",
                html_2 = "请输入您的手机号!",
                html_3 = "您的手机号输入有误!",
                html_4 = "请输入您的地址!";
            if (name.val().trim() == "") {
                $('.pdName').html(html_1);
                toast();
                return false;
            }
            if (phone.val().trim() == "") {
                $('.pdName').html(html_2);
                toast();
                return false;
            } else {
                if (!regPhone.test(phone.val())) {
                    $('.pdName').html(html_3);
                    toast();
                    return false;
                }
            }
            if (address.val().trim() == "") {
                $('.pdName').html(html_4);
                toast();
                return false;
            }
            return true;
        }

        //增加中奖记录
        function getPrize() {
            if (verify()) {
                var requestData = "mobile=" + $("#phone").val()
                    + "&username=" + $("#username").val().trim()
                    + "&address=" + $("#address").val().trim()
                    + "&lottery_record_id=" + $.getQueryString("id")
                    + "&prize_code=" + $.getQueryString("prizecode")
                    + "&prize_name=" + $.getQueryString("prizename");

                $.ajax({
                    type: "post",
                    url: $.domainUrl + "AddGetRecord",
                    data: requestData,
                    success: function (result) {
                        var data = $.parseJSON(result);
                        if (data.Status == 1) {
                            $(".mask-prize").fadeIn();
                            updateGetPrizeStatus();
                        } else if (data.Status == 2) {
                           // alert(data.Message);
                            $('.pdName').html(data.Message);
                            toast();
                        } else if (data.Status == -2) {
                            window.location.href = "load.aspx";
                        } else if (res.Status == -5) {
                            window.location.href = "index.aspx";
                        }
                    }
                });
            }
        }

        //修改领取状态
        function updateGetPrizeStatus() {
            var lottery_record_id = $.getQueryString("id");
            //领取成功修改优惠券状态
            $.ajax({
                type: "post",
                url: $.domainUrl + "UpdatePrizeIsGetStatus",
                data: { id: lottery_record_id },
                success: function (result) {
                    var data = $.parseJSON(result);
                    if (data.Status == 1) {
                        //领取成功
                        $(".mask-prize").fadeIn();
                    } else if (res.Status == -5) {
                        window.location.href = "index.aspx";
                    }
                }
            });
        }


        //不同的情况显示不同的图片
        var prizecode = $.getQueryString("prizecode");
        switch (prizecode) {
            case "P0001": $(".show_pic2").show(); break;
            case "P0002": $(".show_pic1").show(); break;
            case "P0003": $(".prize-xs").show(); break;
        }
    </script>
</body>
</html>